{% extends 'core/base.html' %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-3">
                <h1>{{ strategy.name }}</h1>
                <div class="btn btn-success w-100">Run</div>
                <div class="mt-3">
                    <h3>Dataset</h3>
                    <select class="form-control">
                        {% for dataset in datasets %}
                            <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% if strategy.parameters %}
                    <div class="mt-3">
                    <h3>Parameters</h3>
                    {% for p in strategy.parameters %}
                        <div class="d-flex w-100 justify-content-between mt-1">
                            <div class="w-50">{{ p.alias }}</div>
                            <div class="w-50">
                                <input type="text" class="form-control" value="{{ p.default }}">
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="col-lg-9">
                <h1>Chart</h1>
                <div id="chart"></div>
                <h1>Orders</h1>
                <details>
                    <summary><span class="font-bold">Total ({{ strategy.order_manager.orders | length }})</span>
                    </summary>
                    {% if strategy.orders %}
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Time</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for order in strategy.order_manager.orders %}
                                <tr>
                                    <td>
                                        <div class="border-5 ps-3 {{ 'border-start border-success' if order.side == 'buy' else 'border-start border-danger' }}">
                                            {{ order.id }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="{{ 'text-success' if order.side == 'buy' else 'text-danger' }}">{{ order.side | upper }}</div>
                                    </td>
                                    <td>{{ order.price }}</td>
                                    <td>{{ order.quantity }}</td>
                                    <td>{{ order.timestamp }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </details>
                <h1>Positions</h1>
                <details>
                    <summary><span class="font-bold">Total ({{ strategy.position_manager.positions | length }})</span>
                    </summary>
                    {% if strategy.position_manager.positions %}
                        <div class="row">
                            <div class="col-lg-1">Trade #</div>
                            <div class="col-lg-1">Side</div>
                            <div class="col-lg-1">Prices</div>
                        </div>
                        {% for position in strategy.position_manager.positions %}
                            <div class="row">
                                <div class="col-lg-1">{{ loop.index }}</div>
                                <div class="col-lg-1">{{ position.side }}</div>
                                <div class="col-lg-2">
                                    <div>{{ position.take_profit }} (take profit)</div>
                                    <div>{{ position.price }} (entry)</div>
                                    <div>{{ position.take_loss }} (take loss)</div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </details>
            </div>
        </div>
    </div>
    <script>

        // fetch data
        async function getOhlcv() {
            // make ajax request
            const response = await fetch('/api/v1/data?name=AAPL');
            // parse json
            const data = await response.json();
            // return data
            return data.map(d => {
                return {
                    datetime: new Date(d.datetime),
                    open: d.open,
                    high: d.high,
                    low: d.low,
                    close: d.close,
                    volume: d.volume
                }
            });

        }

        function unpack(rows, key) {
            return rows.map(function (row) {
                return row[key];
            });
        }

        // create chart
        async function createChart() {
            const ohlc = await getOhlcv()

            var trace = {
                x: unpack(ohlc, 'datetime'),
                close: unpack(ohlc, 'close'),
                high: unpack(ohlc, 'high'),
                low: unpack(ohlc, 'low'),
                open: unpack(ohlc, 'open'),

                // cutomise colors
                increasing: {line: {color: 'green'}},
                decreasing: {line: {color: 'red'}},

                type: 'ohlc',
                xaxis: 'x',
                yaxis: 'y'
            };


            var data = [trace];

            console.log(trace)


            var layout = {
                dragmode: 'zoom',
                margin: {
                    r: 10,
                    t: 25,
                    b: 40,
                    l: 60
                },
                showlegend: false,
                xaxis: {
                    autorange: true,
                    title: 'Date',
                    type: 'date'
                },
                yaxis: {
                    autorange: true,
                    type: 'linear'
                }
            };

            Plotly.newPlot('chart', data, layout);
        }

        createChart()
    </script>
{% endblock %}